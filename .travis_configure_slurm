#!/bin/bash
#set -e

hostname=$(hostname)

mkdir -p /etc/slurm-llnl
cat << EOF > /etc/slurm-llnl/slurm.conf
ControlMachine=$hostname
ControlAddr=127.0.0.1

AuthType=auth/munge
ClusterName=linux
CryptoType=crypto/munge
FastSchedule=1
JobAcctGatherType=jobacct_gather/none
JobCompType=jobcomp/none
MpiDefault=none
ProctrackType=proctrack/pgid
ReturnToService=1
SallocDefaultCommand="/usr/bin/srun -n1 -N1 --pty --preserve-env --mpi=none $SHELL"
SchedulerType=sched/backfill
SchedulerPort=7321
SelectType=select/cons_res
SelectTypeParameters=CR_CPU
SlurmctldDebug=3
SlurmdDebug=3

SlurmctldPort=6817
SlurmdPort=6818
SlurmUser=root
SlurmdUser=root
SwitchType=switch/none

# 
# COMPUTE NODES
NodeName=$hostname CPUs=1
PartitionName=debug Nodes=$hostname Default=YES MaxTime=INFINITE State=UP    
EOF
apt-get install -y slurm-llnl

slurmd -C
echo "---------------------------------------------"
cat /etc/slurm-llnl/slurm.conf
echo "---------------------------------------------"

#systemctl restart slurmd
#systemctl restart slurmctld

systemctl status slurmctld.service
systemctl status slurmd.service

systemctl stop slurmd
systemctl stop slurmctld